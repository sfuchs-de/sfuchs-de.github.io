<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Econ Empire</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Apply the pixelated font globally */
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #d0d0d0;
            color: #333;
            overscroll-behavior: none;
            font-size: 0.8rem;
            line-height: 1.2rem;
        }

        /* Kairosoft-style container */
        .kairo-container {
            border: 4px solid #333;
            background-color: #f0f8ff;
            box-shadow: 4px 4px 0px #555;
            margin-bottom: 10px;
            padding: 8px;
        }

        /* --- Intro Welcome Screen Styling (Unchanged) --- */
        #intro-welcome-screen { min-height: 450px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; text-align: center; position: relative; overflow: hidden; background-image: url('http://sfuchs-de.github.io/Pictures/title_background.png'); background-size: cover; background-position: center; }
        #title-image { position: absolute; top: -300px; left: 50%; transform: translateX(-50%); max-width: 60%; height: auto; z-index: 5; transition: top 2s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        #title-image.animate-in { top: 45%; transform: translate(-50%, -50%); }
        #welcome-continue-button { opacity: 0; transition: opacity 0.8s ease-in 0.5s, background-color 0.1s ease-in-out, box-shadow 0.1s ease-in-out, transform 0.1s ease-in-out; margin-bottom: 40px; z-index: 6; background-color: rgba(106, 183, 161, 0.7); border-color: rgba(51, 51, 51, 0.7); box-shadow: 2px 2px 0px rgba(51, 51, 51, 0.7); color: white; }
        #welcome-continue-button:hover { background-color: rgba(90, 155, 217, 0.75); box-shadow: 1px 1px 0px rgba(51, 51, 51, 0.7); transform: translate(1px, 1px); }
        #welcome-continue-button:active { background-color: rgba(74, 138, 199, 0.8); box-shadow: none; transform: translate(2px, 2px); }
        #welcome-continue-button.visible { opacity: 1; }


        /* --- Setup Screen Styling (Unchanged) --- */
        #intro-setup-screen { min-height: 450px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; position: relative; padding: 20px; background-image: url('http://sfuchs-de.github.io/Pictures/title_background.png'); background-size: cover; background-position: center; }
        .setup-overlay { background-color: rgba(240, 248, 255, 0.9); padding: 25px; border-radius: 8px; border: 4px solid #555; box-shadow: 4px 4px 0px #555; width: 90%; max-width: 500px; }
        .setup-overlay h2 { font-size: 1.1rem; margin-bottom: 15px; color: #333; }
        .setup-overlay h4 { font-size: 0.8rem; margin-top: 15px; margin-bottom: 8px; color: #444; border-bottom: 2px solid #ccc; padding-bottom: 4px; display: inline-block; }
        .intro-screen input[type="text"] { border: 2px solid #333; padding: 8px; margin: 5px 0 15px 0; font-family: 'Press Start 2P', cursive; font-size: 0.8rem; background-color: white; box-shadow: 2px 2px 0px #888; width: 100%; border-radius: 3px; }
        .school-choice-button { margin: 8px 0; display: block; width: 100%; white-space: normal !important; line-height: 1.1rem !important; padding-top: 10px !important; padding-bottom: 10px !important; text-align: left; padding-left: 15px !important; padding-right: 15px !important; }
        .school-choice-button .bonus-text { font-size: 0.6rem; opacity: 0.9; display: block; margin-top: 3px; }
        .school-choice-button.selected { border-width: 4px; border-color: #4CAF50; box-shadow: 1px 1px 0px #333; transform: translate(1px, 1px); background-color: #5a9bd9; }


        /* --- Animation Screen Styling (Unchanged) --- */
        #intro-animation-screen { position: relative; height: 450px; width: 100%; background-color: #eee; background-size: cover; background-position: center; overflow: hidden; border: 4px solid #333; box-shadow: 4px 4px 0px #555; }
        #intro-animation-screen.school-ivyleague { background-image: url('https://sfuchs-de.github.io/Pictures/option_1a.png'); }
        #intro-animation-screen.school-tech { background-image: url('https://sfuchs-de.github.io/Pictures/option_2.png'); }
        #intro-animation-screen.school-business { background-image: url('https://sfuchs-de.github.io/Pictures/option_3.png'); }
        .walking-sprite { position: absolute; left: 50%; bottom: -110px; transform: translateX(-50%); width: 60px; height: 100px; background-color: transparent; background-size: contain; background-repeat: no-repeat; background-position: bottom center; transition: bottom 8s linear; z-index: 10; }
        .walking-sprite.step-left { background-image: url('https://sfuchs-de.github.io/Pictures/left_step_2.png'); }
        .walking-sprite.step-right { background-image: url('https://sfuchs-de.github.io/Pictures/right_step_2.png'); }
        .walking-sprite.is-walking { bottom: 14%; }


        /* --- Main Game Styles (Unchanged) --- */
        .top-bar { background-color: #4a90e2; color: white; padding: 8px 12px; border: 4px solid #333; box-shadow: 2px 2px 0px #333 inset; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; font-size: 0.7rem; }
        .top-bar > div { display: flex; align-items: center; }
        .game-area-container { border: 4px solid #333; background-color: #fff; min-height: 350px; box-shadow: 4px 4px 0px #888; margin-bottom: 10px; overflow: hidden; }
        .game-area-main-content { width: 100%; padding: 20px; text-align: center; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 350px; background-size: cover; background-position: center; background-repeat: no-repeat; background-color: #cccccc; }
        .game-area-main-content.stage-phd { background-image: url('https://sfuchs-de.github.io/Pictures/phd_student_office.png'); }
        .game-area-main-content.stage-jobmarket { background-image: url('https://placehold.co/800x400/78909c/ffffff?text=Job+Market+View'); background-color: #e0f7fa; }
        #stage-display { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); color: #fff; background-color: rgba(0, 0, 0, 0.6); padding: 4px 8px; border-radius: 3px; display: inline-block; text-shadow: 1px 1px 2px #000; z-index: 2; font-size: 0.9rem; }
        #current-activity-display { color: #fff; background-color: rgba(0, 0, 0, 0.6); padding: 3px 6px; border-radius: 3px; display: inline-block; margin-top: 5px; text-shadow: 1px 1px 2px #000; z-index: 2; }
        #skill-display { position: absolute; top: 10px; right: 10px; background-color: rgba(0, 0, 0, 0.7); color: #fff; padding: 8px 12px; border-radius: 5px; border: 2px solid #aaa; font-size: 0.6rem; /* Smaller font */ line-height: 0.9rem; text-align: left; z-index: 3; min-width: 130px; /* Wider */ }
        #skill-display h4 { font-size: 0.65rem; margin-bottom: 4px; text-align: center; border-bottom: 1px solid #aaa; padding-bottom: 2px; }
        #skill-display p { margin: 1px 0; } /* Tighter spacing */
        .bottom-bar { background-color: #e0e0e0; padding: 10px; border: 4px solid #333; box-shadow: 0px -2px 0px #333 inset; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .bottom-bar-stats { display: flex; justify-content: center; align-items: center; width: 100%; background-color: rgba(0, 0, 0, 0.05); padding: 6px; border-radius: 4px; border: 1px solid #bbb; font-size: 0.65rem; flex-wrap: wrap; gap: 10px; }
        .bottom-bar-stats > div { flex-shrink: 0; text-align: center; }
        .course-display { width: 100%; background-color: rgba(0, 0, 0, 0.05); padding: 8px; border-radius: 4px; border: 1px solid #bbb; margin-bottom: 10px; font-size: 0.65rem; text-align: center; }
        .course-display h4 { font-size: 0.7rem; margin-bottom: 5px; font-weight: bold; }
        .course-display ul { list-style: none; padding: 0; margin: 0; }
        .course-display li { margin-bottom: 3px; }
        .course-display .course-progress { font-size: 0.6rem; color: #555; margin-left: 5px; }
        .action-button-area { display: flex; justify-content: center; flex-wrap: wrap; gap: 15px; width: 100%; }
        .message-log-container { width: 100%; margin-top: 10px; padding: 6px 8px; background-color: #e0e0e0; border: 2px solid #bbb; border-radius: 4px; }
        .message-log { border: 2px solid #bbb; background-color: #fff; height: 2.4rem; overflow-y: scroll; padding: 6px; font-size: 0.6rem; line-height: 0.9rem; width: 100%; }
        .message-log p { margin-bottom: 4px; color: #333; }
        .status-bar-container { height: 12px; width: 60px; background-color: #aaa; border: 1px solid #333; overflow: hidden; display: inline-block; vertical-align: middle; margin-left: 5px; }
        .status-bar-fill { height: 100%; background-color: #4caf50; transition: width 0.2s ease-out; }
        .status-bar-fill.motivation { background-color: #ff9800; }
        .game-button { /* Base button style */ background-color: #6ab7a1; color: white; padding: 8px 12px; border: 2px solid #333; box-shadow: 2px 2px 0px #333; cursor: pointer; text-align: center; margin: 2px; font-size: 0.65rem; line-height: 0.9rem; transition: all 0.1s ease-in-out; border-radius: 3px; }
        .game-button:not(#welcome-continue-button):not(.school-choice-button):hover { background-color: #5a9bd9; box-shadow: 1px 1px 0px #333; transform: translate(1px, 1px); }
        .game-button:not(#welcome-continue-button):not(.school-choice-button):active { background-color: #4a8ac7; box-shadow: none; transform: translate(2px, 2px); }
        .game-button.disabled { background-color: #aaa !important; color: #eee !important; cursor: not-allowed !important; box-shadow: 2px 2px 0px #777 !important; transform: none !important; }
        [data-tooltip] { position: relative; cursor: help; }
        [data-tooltip]::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-5px); background-color: rgba(0, 0, 0, 0.85); color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.7rem; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; z-index: 10; font-family: sans-serif; }
        [data-tooltip]:hover::after { opacity: 1; visibility: visible; }
        .week-progress-container { width: 50px; height: 8px; background-color: #ccc; border: 1px solid #333; display: inline-block; vertical-align: middle; margin-left: 5px; }
        .week-progress-fill { width: 0%; height: 100%; background-color: #777; transition: width 0.1s linear; }
        .hidden { display: none !important; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); /* Darker overlay */ display: flex; justify-content: center; align-items: center; z-index: 50; padding: 20px; }
        .overlay-content { background-color: #f0f8ff; border: 4px solid #333; box-shadow: 6px 6px 0px #555; padding: 20px; border-radius: 5px; max-width: 90%; width: 500px; text-align: center; max-height: 80vh; /* Limit height */ display: flex; flex-direction: column; }
        .overlay-content h3 { font-size: 1rem; margin-bottom: 15px; flex-shrink: 0; }
        .overlay-content p { font-size: 0.75rem; line-height: 1.1rem; margin-bottom: 10px; } /* Style for message text */
        .overlay-content ul { list-style: none; padding: 0; margin: 0 0 15px 0; overflow-y: auto; /* Scroll if list too long */ flex-grow: 1; text-align: left; /* Align list items left */ }
        .overlay-content li { margin-bottom: 8px; }
        .overlay-content .button-container { margin-top: 15px; flex-shrink: 0; } /* Container for close button */
        .overlay-content .game-button { display: inline-block; margin: 5px; } /* Allow multiple buttons side-by-side */
        #exam-results-list li { padding: 5px; border-bottom: 1px dashed #ccc; text-align: left; }
        #exam-results-list li:last-child { border-bottom: none; }
        #exam-results-list .grade-A { color: #2a9d8f; font-weight: bold; }
        #exam-results-list .grade-B { color: #3a86ff; }
        #exam-results-list .grade-C { color: #e9c46a; }
        #exam-results-list .grade-F { color: #e76f51; font-weight: bold; }
        /* Course Selection Overlay Styles */
        #course-selection-list label { display: block; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px; cursor: pointer; background-color: #fff; transition: background-color 0.2s; }
        #course-selection-list label:hover { background-color: #e0e0e0; }
        #course-selection-list input[type="checkbox"] { margin-right: 10px; vertical-align: middle; accent-color: #4a90e2; /* Style checkbox */ }
        #course-selection-list span { vertical-align: middle; font-size: 0.7rem; }
        #course-selection-list label.selected { background-color: #a8d5ba; border-color: #559a6a; }
        #course-count { font-size: 0.7rem; margin-bottom: 10px; font-weight: bold; }

    </style>
</head>
<body class="p-2 md:p-4 max-w-4xl mx-auto">

    <div id="intro-welcome-screen" class="kairo-container intro-screen"> <img id="title-image" src="https://sfuchs-de.github.io/Pictures/title.png" alt="Econ Empire Title"> <button id="welcome-continue-button" class="game-button">Begin Journey</button> </div>
    <div id="intro-setup-screen" class="kairo-container intro-screen hidden">
        <div class="setup-overlay">
            <h2 class="text-xl mb-4">ðŸŽ“ Character Setup ðŸŽ“</h2>
            <h4>Enter Your Name:</h4>
            <input type="text" id="player-name" name="player-name" maxlength="20" placeholder="e.g., Prof. Pixel">
            <h4 class="mt-4">Choose Your Starting Path:</h4>
            <button class="game-button school-choice-button" data-school="Ivy League" data-bonus="theory">
                Ivy League <br>
                <span class="bonus-text">ðŸ§  (Harder Start - Theory Boost)</span>
            </button>
            <button class="game-button school-choice-button" data-school="Tech Institute" data-bonus="metrics">
                Tech Institute <br>
                <span class="bonus-text">ðŸ“Š (Balanced - Metrics Boost)</span>
            </button>
            <button class="game-button school-choice-button" data-school="Business School" data-bonus="funding">
                Business School <br>
                <span class="bonus-text">ðŸ’° (Easier Start - More Funding)</span>
            </button>
            <button id="setup-start-button" class="game-button text-lg px-6 py-3 mt-6 disabled" disabled>Start PhD</button>
        </div>
    </div>
    <div id="intro-animation-screen" class="hidden" data-school=""> <p id="animation-text" class="absolute top-5 left-5 text-white text-shadow-lg bg-black bg-opacity-50 p-2 rounded">Starting your journey...</p> </div>


    <div id="main-game-interface" class="hidden">
        <div class="top-bar mb-2"> <div id="time-display" data-tooltip="Current game time"> ðŸ“… Y:1 F W:1 <div class="week-progress-container"><div id="week-progress-fill" class="week-progress-fill"></div></div> </div> <div data-tooltip="Money available">ðŸ’° $<span id="funding-display">500</span></div> <div data-tooltip="Energy for actions">âš¡ <span id="energy-value">100</span>/<span id="energy-max">100</span> <div class="status-bar-container"><div id="energy-bar" class="status-bar-fill" style="width: 100%;"></div></div> </div> <div data-tooltip="Willpower">ðŸ’¡ <span id="motivation-value">100</span>/<span id="motivation-max">100</span> <div class="status-bar-container"><div id="motivation-bar" class="status-bar-fill motivation" style="width: 100%;"></div></div> </div> </div>
        <div id="game-area-container" class="game-area-container"> <div id="game-area-main-content" class="game-area-main-content"> <div id="skill-display"> <h4>Skills</h4> <p>Micro: <span id="skill-micro">0</span></p> <p>Macro: <span id="skill-macro">0</span></p> <p>Metrics: <span id="skill-metrics">0</span></p> <p class="mt-2">Labor: <span id="skill-labor">0</span></p> <p>Public: <span id="skill-public">0</span></p> <p>IO: <span id="skill-io">0</span></p> </div> <h2 class="text-lg mb-2" id="stage-display">Stage: PhD Student</h2> <p id="current-activity-display" class="text-xs h-4"></p> </div> </div>
        <div class="bottom-bar"> <div class="bottom-bar-stats"> <div data-tooltip="Primary Goal" id="goal-display">Goal: Pass Term 1 Courses</div> </div> <div id="course-display" class="course-display"> <h4>Term <span id="current-term-display">1</span> Courses</h4> <ul id="course-list"> <li>Loading...</li> </ul> </div> <div id="action-buttons" class="action-button-area"> </div> </div>
        <div class="message-log-container"> <div id="message-log" class="message-log"> </div> </div>
    </div>

    <div id="term-start-overlay" class="overlay hidden"> <div class="overlay-content kairo-container"> <h3 id="term-start-title">Term Starting!</h3> <p id="term-start-message" class="mb-4 text-sm"></p> <ul id="term-start-courses" class="mb-4 text-sm"></ul> <div class="button-container"><button id="term-start-continue" class="game-button">Continue</button></div> </div> </div>
    <div id="study-submenu" class="overlay hidden"> <div class="overlay-content kairo-container"> <h3>Study Options</h3> <ul id="study-submenu-list" class="mb-4"> </ul> <div class="button-container"><button id="study-submenu-close" class="game-button">Close</button></div> </div> </div>
    <div id="buy-window" class="overlay hidden"> <div class="overlay-content kairo-container"> <h3>Buy Items (Placeholder)</h3> <p class="mb-4">Item shop coming soon!</p> <ul> <li>Coffee Machine - $50</li> <li>Textbook - $80</li> <li>Comfy Chair - $150</li> </ul> <div class="button-container"><button id="buy-window-close" class="game-button">Close</button></div> </div> </div>
    <div id="exam-phase-overlay" class="overlay hidden"> <div class="overlay-content kairo-container"> <h3 id="exam-phase-title">End of Term Exams</h3> <p class="mb-4 text-sm">Revealing your results...</p> <ul id="exam-results-list" class="mb-4 text-sm"> </ul> <p id="exam-phase-summary" class="mb-4 font-bold"></p> <div class="button-container"> <button id="exam-phase-continue" class="game-button hidden">Next Term</button> <button id="exam-phase-restart" class="game-button hidden">Restart Game</button> </div> </div> </div>
    <div id="course-selection-overlay" class="overlay hidden"> <div class="overlay-content kairo-container"> <h3 id="course-selection-title">Term 3 Field Course Selection</h3> <p class="mb-4 text-sm">Choose exactly 3 field courses for this term.</p> <p id="course-count" class="mb-2">Selected: 0 / 3</p> <ul id="course-selection-list" class="mb-4 text-sm"> </ul> <div class="button-container"> <button id="course-confirm-button" class="game-button disabled" disabled>Confirm Courses</button> </div> </div> </div>
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4"> <div class="bg-white p-5 rounded-lg shadow-xl text-center max-w-xs mx-auto kairo-container"> <h2 id="modal-title" class="text-lg mb-3">Game Over</h2> <p id="modal-message" class="mb-4 text-sm">You ran out of motivation!</p> <button id="modal-button" class="game-button">Restart</button> </div> </div>

    <script>
        // --- Game Constants & State ---
        const TICKS_PER_WEEK = 5;
        const WEEKS_PER_SEASON = 15; // Term length
        const SEASONS = ['Fall', 'Spring'];
        const SUMMER_WEEKS = 8;
        const BASE_GAME_SPEED = 1000;
        const ANIMATION_DURATION = 8000;
        const TITLE_ANIMATION_DURATION_MS = 2000;
        const BUTTON_FADE_IN_DELAY_MS = 500;
        const STEP_INTERVAL_MS = 350;
        const COURSEWORK_TERMS = 4;
        const EXAM_PASS_THRESHOLD = 80;
        const GRADE_THRESHOLDS = { A: 95, B: 85, C: 70 };
        const GRADE_MOTIVATION = { A: 15, B: 5, C: -10, F: -30 };

        // --- UPDATED: Field Courses & Specializations ---
        const fieldCourses = {
            // Term 3 Options (Choose 3)
            term3: [
                { name: "Labor Economics I", skill: "laborEcon", difficulty: 1.1, specialization: "Applied Microeconomics" },
                { name: "Public Finance I", skill: "publicFinance", difficulty: 1.1, specialization: "Applied Microeconomics" },
                { name: "Industrial Org I", skill: "ioEcon", difficulty: 1.2, specialization: "Applied Microeconomics" },
                { name: "Int'l Trade I", skill: "tradeEcon", difficulty: 1.2, specialization: "Macroeconomics & International" },
                { name: "Financial Econ I", skill: "financeEcon", difficulty: 1.3, specialization: "Finance" },
                { name: "Behavioral Econ I", skill: "behavioralEcon", difficulty: 1.1, specialization: "Economic Theory & Behavioral" },
            ],
            // Term 4 Options (Choose 3)
            term4: [
                 { name: "Labor Economics II", skill: "laborEcon", difficulty: 1.2, prerequisite: "Labor Economics I", specialization: "Applied Microeconomics" },
                 { name: "Public Finance II", skill: "publicFinance", difficulty: 1.2, prerequisite: "Public Finance I", specialization: "Applied Microeconomics" },
                 { name: "Industrial Org II", skill: "ioEcon", difficulty: 1.3, prerequisite: "Industrial Org I", specialization: "Applied Microeconomics" },
                 { name: "Int'l Trade II", skill: "tradeEcon", difficulty: 1.3, prerequisite: "Int'l Trade I", specialization: "Macroeconomics & International" },
                 { name: "Financial Econ II", skill: "financeEcon", difficulty: 1.4, prerequisite: "Financial Econ I", specialization: "Finance" },
                 { name: "Behavioral Econ II", skill: "behavioralEcon", difficulty: 1.2, prerequisite: "Behavioral Econ I", specialization: "Economic Theory & Behavioral" },
            ]
            // TODO: Add more field courses if desired
        };

        const courseCatalog = {
            1: [ { name: "Micro Theory I", skill: "microTheory", difficulty: 1.0 }, { name: "Macro Theory I", skill: "macroTheory", difficulty: 1.0 }, { name: "Econometrics I", skill: "econometrics", difficulty: 1.1 }, ],
            2: [ { name: "Micro Theory II", skill: "microTheory", prerequisite: "Micro Theory I", difficulty: 1.1 }, { name: "Macro Theory II", skill: "macroTheory", prerequisite: "Macro Theory I", difficulty: 1.1 }, { name: "Econometrics II", skill: "econometrics", prerequisite: "Econometrics I", difficulty: 1.2 }, ],
            // Term 3/4 Compulsory courses (will be combined with electives)
            3: [ { name: "Advanced Micro", skill: "microTheory", prerequisite: "Micro Theory II", difficulty: 1.2, specialization: "Economic Theory & Behavioral" } ],
            4: [ { name: "Advanced Macro", skill: "macroTheory", prerequisite: "Macro Theory II", difficulty: 1.2, specialization: "Macroeconomics & International" } ],
        };

        const gameState = {
            playerName: "Player", chosenSchool: null, gamePhase: 'intro-welcome', // Start at welcome
            time: { year: 1, season: 'Fall', week: 1, tick: 0 },
            currentTerm: 1, currentCourses: [], completedCourses: {},
            resources: { funding: 500, energy: 100, maxEnergy: 100, motivation: 100, maxMotivation: 100 },
            stats: { microTheory: 5, macroTheory: 5, econometrics: 5, laborEcon: 0, publicFinance: 0, ioEcon: 0, tradeEcon: 0, financeEcon: 0, behavioralEcon: 0, advisorRelationship: 50, dissertationChapters: 0, requiredChapters: 5, jmpQuality: 0, publications: 0, citations: 0, reputation: 0 },
            specialization: null,
            currentStage: 'PhD (Coursework)', currentActivity: null,
            advisor: { name: "Prof. Smith", field: "Micro Theory", personality: "Grumpy" },
            gameOver: false, gameSpeed: BASE_GAME_SPEED, logMessages: [], maxLogMessages: 10, gameLoopTimeoutId: null,
            steppingIntervalId: null, isOverlayVisible: false,
            examCoursesToGrade: [], examOverallResult: null,
        };

        // --- UI Elements ---
        // (Selectors remain the same)
        const introWelcomeScreen = document.getElementById('intro-welcome-screen');
        const introSetupScreen = document.getElementById('intro-setup-screen');
        const introAnimationScreen = document.getElementById('intro-animation-screen');
        const welcomeContinueButton = document.getElementById('welcome-continue-button');
        const playerNameInput = document.getElementById('player-name');
        const schoolChoiceButtons = document.querySelectorAll('.school-choice-button');
        const setupStartButton = document.getElementById('setup-start-button');
        const animationText = document.getElementById('animation-text');
        const titleImage = document.getElementById('title-image');
        const mainGameInterface = document.getElementById('main-game-interface');
        const timeDisplay = document.getElementById('time-display');
        const weekProgressFill = document.getElementById('week-progress-fill');
        const fundingDisplay = document.getElementById('funding-display');
        const energyValue = document.getElementById('energy-value');
        const energyMax = document.getElementById('energy-max');
        const energyBar = document.getElementById('energy-bar');
        const motivationValue = document.getElementById('motivation-value');
        const motivationMax = document.getElementById('motivation-max');
        const motivationBar = document.getElementById('motivation-bar');
        const stageDisplay = document.getElementById('stage-display');
        const goalDisplay = document.getElementById('goal-display');
        const characterStatus = document.getElementById('character-status'); // Selector still exists, just not used in update
        const currentActivityDisplay = document.getElementById('current-activity-display');
        const actionButtonsContainer = document.getElementById('action-buttons');
        const statsMicro = document.getElementById('skill-micro');
        const statsMacro = document.getElementById('skill-macro');
        const statsMetrics = document.getElementById('skill-metrics');
        const skillLabor = document.getElementById('skill-labor');
        const skillPublic = document.getElementById('skill-public');
        const skillIO = document.getElementById('skill-io'); // Add others if displayed
        const messageLog = document.getElementById('message-log');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalButton = document.getElementById('modal-button');
        const gameAreaMainContent = document.getElementById('game-area-main-content');
        const courseDisplayContainer = document.getElementById('course-display');
        const currentTermDisplay = document.getElementById('current-term-display');
        const courseList = document.getElementById('course-list');
        const skillDisplay = document.getElementById('skill-display');
        const termStartOverlay = document.getElementById('term-start-overlay');
        const termStartTitle = document.getElementById('term-start-title');
        const termStartMessage = document.getElementById('term-start-message');
        const termStartCourses = document.getElementById('term-start-courses');
        const termStartContinue = document.getElementById('term-start-continue');
        const studySubmenu = document.getElementById('study-submenu');
        const studySubmenuList = document.getElementById('study-submenu-list');
        const studySubmenuClose = document.getElementById('study-submenu-close');
        const buyWindow = document.getElementById('buy-window');
        const buyWindowClose = document.getElementById('buy-window-close');
        const examPhaseOverlay = document.getElementById('exam-phase-overlay');
        const examPhaseTitle = document.getElementById('exam-phase-title');
        const examResultsList = document.getElementById('exam-results-list');
        const examPhaseSummary = document.getElementById('exam-phase-summary');
        const examPhaseContinue = document.getElementById('exam-phase-continue');
        const examPhaseRestart = document.getElementById('exam-phase-restart');
        const courseSelectionOverlay = document.getElementById('course-selection-overlay');
        const courseSelectionTitle = document.getElementById('course-selection-title');
        const courseSelectionList = document.getElementById('course-selection-list');
        const courseConfirmButton = document.getElementById('course-confirm-button');
        const courseCountDisplay = document.getElementById('course-count');


        // --- Utility Functions (Define BEFORE use) ---
        function logMessage(message) { console.log(message); const timePrefix = `[Y${gameState.time.year}${gameState.time.season[0]}W${gameState.time.week}]`; gameState.logMessages.push(`${timePrefix} ${message}`); if (gameState.logMessages.length > gameState.maxLogMessages) { gameState.logMessages.shift(); } updateLogUI(); }
        function updateLogUI() { if (!messageLog) return; messageLog.innerHTML = ''; gameState.logMessages.forEach(msg => { const p = document.createElement('p'); p.textContent = msg; messageLog.appendChild(p); }); messageLog.scrollTop = messageLog.scrollHeight; }
        function updateStatsUI() { if(skillDisplay) { if(statsMicro) statsMicro.textContent = gameState.stats.microTheory.toFixed(0); if(statsMacro) statsMacro.textContent = gameState.stats.macroTheory.toFixed(0); if(statsMetrics) statsMetrics.textContent = gameState.stats.econometrics.toFixed(0); if(skillLabor) skillLabor.textContent = (gameState.stats.laborEcon || 0).toFixed(0); if(skillPublic) skillPublic.textContent = (gameState.stats.publicFinance || 0).toFixed(0); if(skillIO) skillIO.textContent = (gameState.stats.ioEcon || 0).toFixed(0); /* Add others */ } }
        function updateResourcesUI() { if(!fundingDisplay || !energyValue || !energyMax || !energyBar || !motivationValue || !motivationMax || !motivationBar) return; fundingDisplay.textContent = gameState.resources.funding; energyValue.textContent = gameState.resources.energy; energyMax.textContent = gameState.resources.maxEnergy; energyBar.style.width = `${(gameState.resources.energy / gameState.resources.maxEnergy) * 100}%`; motivationValue.textContent = gameState.resources.motivation; motivationMax.textContent = gameState.resources.maxMotivation; motivationBar.style.width = `${(gameState.resources.motivation / gameState.resources.maxMotivation) * 100}%`; }
        function updateTimeUI() { if(!timeDisplay || !weekProgressFill) return; timeDisplay.childNodes[0].nodeValue = `ðŸ“… Y:${gameState.time.year} ${gameState.time.season[0]} W:${gameState.time.week} `; const progressPercent = ((gameState.time.tick + 1) / TICKS_PER_WEEK) * 100; weekProgressFill.style.width = `${progressPercent}%`; }
        function updateGoalUI() { if(!goalDisplay) return; if (gameState.currentStage === 'PhD (Coursework)') { goalDisplay.textContent = `Goal: Pass Term ${gameState.currentTerm} Courses`; } else if (gameState.currentStage === 'PhD (Exams)') { goalDisplay.textContent = `Goal: Awaiting Exam Results...`; } else if (gameState.currentStage === 'PhD (Research)') { goalDisplay.textContent = `Goal: Chapters ${gameState.stats.dissertationChapters}/${gameState.stats.requiredChapters}`; } else if (gameState.currentStage === 'JobMarket') { goalDisplay.textContent = `Goal: Get Job (JMP: ${gameState.stats.jmpQuality})`; } else { goalDisplay.textContent = "Goal: Survive"; } }
        function updateCharacterStatusUI() { if (!currentActivityDisplay) return; if (gameState.currentActivity) { currentActivityDisplay.textContent = `${gameState.currentActivity.name} (${gameState.currentActivity.remaining}t)`; currentActivityDisplay.classList.remove('hidden'); } else { currentActivityDisplay.textContent = ""; currentActivityDisplay.classList.add('hidden'); } }
        function updateCourseUI() { if (!courseList || !currentTermDisplay) return; currentTermDisplay.textContent = gameState.currentTerm; courseList.innerHTML = ''; console.log('Updating Course UI. Current Courses:', JSON.stringify(gameState.currentCourses)); if (gameState.currentCourses.length === 0 && gameState.currentStage === 'PhD (Coursework)') { courseList.innerHTML = '<li>No courses this term.</li>'; } else if (gameState.currentCourses.length > 0) { gameState.currentCourses.forEach(course => { const li = document.createElement('li'); li.innerHTML = `${course.name} <span class="course-progress">[${course.understanding.toFixed(0)}/100]</span>`; courseList.appendChild(li); }); } else { courseList.innerHTML = '<li>-</li>'; } }
        function updateGameAreaBackground() { if (!gameAreaMainContent) return; gameAreaMainContent.classList.remove('stage-phd', 'stage-jobmarket', 'stage-assistantprof', 'stage-posttenure'); let stageClass = 'stage-phd'; if (gameState.currentStage === 'JobMarket') stageClass = 'stage-jobmarket'; gameAreaMainContent.classList.add(stageClass); }
        function getStageName(stageKey) { return stageKey; }
        function canAfford(cost) { return gameState.resources.energy >= (cost.energy > 0 ? cost.energy : 0) && gameState.resources.motivation >= (cost.motivation > 0 ? cost.motivation : 0) && gameState.resources.funding >= (cost.funding > 0 ? cost.funding : 0); }
        function showOverlay(overlayElement) { if (!overlayElement) return; gameState.isOverlayVisible = true; overlayElement.classList.remove('hidden'); console.log("Overlay shown:", overlayElement.id); }
        function hideOverlay(overlayElement) { if (!overlayElement) return; gameState.isOverlayVisible = false; overlayElement.classList.add('hidden'); console.log("Overlay hidden:", overlayElement.id); }
        function showModal(title, message, isGameOver = false) { modalTitle.textContent = title; modalMessage.textContent = message; if (isGameOver) { modalButton.textContent = "Restart"; modalButton.onclick = () => window.location.reload(); } else { modalButton.textContent = "Continue"; modalButton.onclick = hideModal; } showOverlay(modal); }
        function hideModal() { hideOverlay(modal); }
        function showTermStartOverlay(term, courses) { if (!termStartOverlay || !termStartTitle || !termStartMessage || !termStartCourses) { console.error("Term start overlay elements not found!"); return; } termStartTitle.textContent = `Term ${term} Starting!`; termStartCourses.innerHTML = ''; if (term === 1) { termStartMessage.textContent = `Welcome, ${gameState.playerName}, to your first term at ${gameState.chosenSchool}! Your journey to becoming a leading economist starts now. The first year focuses on the core sequence (Micro, Macro, Metrics). These courses are compulsory. Good luck!`; } else if (term === 2) { termStartMessage.textContent = `Year ${gameState.time.year}, ${gameState.time.season}. The core sequence continues. These courses are compulsory. Keep up the hard work!`; } else { termStartMessage.textContent = `Year ${gameState.time.year}, ${gameState.time.season}. Time to choose field courses!`; } if (courses && courses.length > 0) { courses.forEach(c => { const li = document.createElement('li'); li.textContent = c.name; termStartCourses.appendChild(li); }); } else { termStartCourses.innerHTML = '<li>No courses assigned for this term yet.</li>'; } showOverlay(termStartOverlay); }
        function updateUI() { if (gameState.gameOver || gameState.gamePhase !== 'main-game') return; console.log("updateUI called"); try { updateTimeUI(); updateResourcesUI(); updateStatsUI(); updateGoalUI(); updateCharacterStatusUI(); if(stageDisplay) stageDisplay.textContent = `Stage: ${getStageName(gameState.currentStage)}`; updateGameAreaBackground(); updateCourseUI(); renderActionButtons(); console.log("updateUI finished successfully"); } catch(e) { console.error("Error during UI Update:", e); } }

        // --- Coursework & Actions Logic ---
        // --- UPDATED: enrollInCourses triggers selection overlay for Term 3+ ---
        function enrollInCourses(term) {
            gameState.currentTerm = term;
            gameState.currentCourses = []; // Clear previous courses
            const compulsoryCourses = courseCatalog[term] || [];
            let coursesForOverlay = [];

            console.log(`Attempting enrollment for Term ${term}.`);

            // 1. Handle Compulsory Courses for this term
            compulsoryCourses.forEach(courseDef => {
                // Skip elective placeholders in compulsory list
                if (courseDef.name.includes("Elective")) return;

                let canEnroll = !courseDef.prerequisite || ['A', 'B', 'C'].includes(gameState.completedCourses[courseDef.prerequisite]);
                if (canEnroll) {
                    gameState.currentCourses.push({ name: courseDef.name, skill: courseDef.skill, understanding: 0, difficulty: courseDef.difficulty || 1.0 });
                    coursesForOverlay.push({ name: courseDef.name });
                } else {
                    logMessage(`Cannot enroll in compulsory ${courseDef.name} - prerequisite ${courseDef.prerequisite} not passed.`);
                    gameState.gameOver = true;
                    setTimeout(() => showModal("Prerequisite Failed!", `Cannot continue without passing ${courseDef.prerequisite}. Your PhD journey ends here.`, true), 100);
                    return; // Stop enrollment process
                }
            });

            if (gameState.gameOver) return; // Stop if failed prereq

            // 2. Handle Elective Selection (Terms 3+)
            if (term >= 3 && term <= COURSEWORK_TERMS) {
                 console.log("Showing course selection for Term", term);
                 showCourseSelectionOverlay(term); // Show selection overlay
                 // Actual enrollment of electives happens via handleConfirmCourses
                 // We don't show the term start overlay yet.
            } else if (term > COURSEWORK_TERMS) {
                 logMessage(`Coursework phase complete.`);
                 gameState.currentStage = 'PhD (Research)'; // Transition stage
                 updateCourseUI();
                 updateGoalUI();
            } else {
                 // For Terms 1 & 2, show Term Start overlay immediately after enrolling
                 logMessage(`Enrolled in Term ${term} courses.`);
                 console.log('Current Courses after enrollment:', JSON.stringify(gameState.currentCourses));
                 if (gameState.gamePhase === 'main-game') { // Only show after intro
                      showTermStartOverlay(term, coursesForOverlay);
                 }
                 updateCourseUI();
                 updateGoalUI();
            }
        }

        // --- NEW: Course Selection Logic ---
        function showCourseSelectionOverlay(term) {
            if (!courseSelectionOverlay || !courseSelectionList || !courseConfirmButton || !courseCountDisplay) { console.error("Course selection overlay elements missing!"); return; }
            courseSelectionTitle.textContent = `Term ${term} Field Course Selection`;
            courseSelectionList.innerHTML = '';
            courseConfirmButton.classList.add('disabled'); courseConfirmButton.disabled = true;
            courseCountDisplay.textContent = `Selected: 0 / 3`;

            const termKey = `term${term}`;
            const availableFields = fieldCourses[termKey] || [];

            availableFields.forEach((courseDef, index) => {
                 let canEnroll = !courseDef.prerequisite || ['A', 'B', 'C'].includes(gameState.completedCourses[courseDef.prerequisite]);
                 const li = document.createElement('li');
                 const label = document.createElement('label');
                 label.htmlFor = `field_course_${index}`;
                 label.className = canEnroll ? "cursor-pointer" : "cursor-not-allowed opacity-50";

                 const checkbox = document.createElement('input');
                 checkbox.type = 'checkbox';
                 checkbox.id = `field_course_${index}`;
                 checkbox.value = index; // Store index
                 checkbox.className = "mr-2";
                 checkbox.disabled = !canEnroll; // Disable if prereq not met
                 if (canEnroll) {
                    checkbox.addEventListener('change', handleCourseSelectionChange);
                 }

                 label.appendChild(checkbox);
                 label.appendChild(document.createTextNode(`${courseDef.name} (+${courseDef.skill})`));
                 if (!canEnroll) {
                     label.appendChild(document.createTextNode(` (Requires: ${courseDef.prerequisite})`));
                 }
                 li.appendChild(label);
                 courseSelectionList.appendChild(li);
            });

            showOverlay(courseSelectionOverlay);
        }

        function handleCourseSelectionChange() {
             const selectedCheckboxes = courseSelectionList.querySelectorAll('input[type="checkbox"]:checked');
             const count = selectedCheckboxes.length;
             courseCountDisplay.textContent = `Selected: ${count} / 3`;
             if (count === 3) { courseConfirmButton.classList.remove('disabled'); courseConfirmButton.disabled = false; }
             else { courseConfirmButton.classList.add('disabled'); courseConfirmButton.disabled = true; }
             // Toggle visual style for selected labels
             courseSelectionList.querySelectorAll('label').forEach(label => {
                 const checkbox = label.querySelector('input[type="checkbox"]');
                 if (checkbox.checked) { label.classList.add('selected'); }
                 else { label.classList.remove('selected'); }
             });
        }

        function handleConfirmCourses() {
            const selectedCheckboxes = courseSelectionList.querySelectorAll('input[type="checkbox"]:checked');
            if (selectedCheckboxes.length !== 3) { return; } // Should be prevented by button state

            const termKey = `term${gameState.currentTerm}`;
            const availableFields = fieldCourses[termKey] || [];
            let coursesForOverlay = [...gameState.currentCourses]; // Start with compulsory
            let specializationsChosen = {};

            // Add selected electives
            selectedCheckboxes.forEach(checkbox => {
                const index = parseInt(checkbox.value);
                const courseDef = availableFields[index];
                if (courseDef) {
                    gameState.currentCourses.push({ name: courseDef.name, skill: courseDef.skill, understanding: 0, difficulty: courseDef.difficulty || 1.0 });
                    coursesForOverlay.push({ name: courseDef.name });
                    const spec = courseDef.specialization;
                    specializationsChosen[spec] = (specializationsChosen[spec] || 0) + 1;
                }
            });

            // Determine specialization
            let maxCount = 0; let primarySpecialization = null;
            for (const spec in specializationsChosen) { if (specializationsChosen[spec] > maxCount) { maxCount = specializationsChosen[spec]; primarySpecialization = spec; } }
            if (primarySpecialization && maxCount >= 2) { gameState.specialization = primarySpecialization; logMessage(`Specialization leaning towards: ${primarySpecialization}`); }

            logMessage(`Selected and enrolled in Term ${gameState.currentTerm} courses.`);
            console.log('Current Courses after selection:', JSON.stringify(gameState.currentCourses));

            hideOverlay(courseSelectionOverlay);
            showTermStartOverlay(gameState.currentTerm, coursesForOverlay); // Show term start with confirmed courses
            updateCourseUI(); updateGoalUI();
        }


        // --- UPDATED: calculateGrade includes skill bonus ---
        function calculateGrade(understanding, skillValue = 5) { const skillBonus = Math.floor(skillValue / 10); const randomFactor = (Math.random() * 10) - 5; /* Reduced randomness */ const finalScore = Math.max(0, Math.min(100, understanding + skillBonus + randomFactor)); console.log(`Calculating grade: Und=${understanding.toFixed(1)}, Skill=${skillValue.toFixed(0)}, Bonus=${skillBonus}, Rand=${randomFactor.toFixed(1)}, Final=${finalScore.toFixed(1)}`); if (finalScore >= GRADE_THRESHOLDS.A) return 'A'; if (finalScore >= GRADE_THRESHOLDS.B) return 'B'; if (finalScore >= GRADE_THRESHOLDS.C) return 'C'; return 'F'; }
        // --- UPDATED: revealNextGrade passes skill ---
        function revealNextGrade() { if (gameState.examCoursesToGrade.length === 0) { finishExamPhase(); return; } const course = gameState.examCoursesToGrade.shift(); const relevantSkillValue = gameState.stats[course.skill] || 0; const grade = calculateGrade(course.understanding, relevantSkillValue); gameState.completedCourses[course.name] = grade; const motivationChange = GRADE_MOTIVATION[grade] || 0; gameState.resources.motivation = Math.max(0, Math.min(gameState.resources.maxMotivation, gameState.resources.motivation + motivationChange)); const li = document.createElement('li'); li.innerHTML = `${course.name}: <span class="grade-${grade}">${grade}</span> (Und: ${course.understanding.toFixed(0)}, Skill: ${relevantSkillValue.toFixed(0)})`; examResultsList.appendChild(li); logMessage(`Exam result for ${course.name}: ${grade}`); if (grade === 'F') { gameState.examOverallResult = 'FAIL'; } setTimeout(revealNextGrade, 750); }
        // --- Other functions (runExamPhase, finishExamPhase, proceedToNextTerm, etc. unchanged unless prerequisite check needed update) ---
        function runExamPhase() { const coursesToGrade = gameState.currentCourses; if (coursesToGrade.length === 0) { proceedToNextTerm(); return; } console.log("Running Exam Phase for Term", gameState.currentTerm); gameState.currentStage = 'PhD (Exams)'; updateUI(); gameState.examCoursesToGrade = [...coursesToGrade]; gameState.examOverallResult = 'PASS'; examResultsList.innerHTML = ''; examPhaseSummary.textContent = 'Calculating results...'; examPhaseContinue.classList.add('hidden'); examPhaseRestart.classList.add('hidden'); showOverlay(examPhaseOverlay); revealNextGrade(); }
        function finishExamPhase() { console.log("Finishing Exam Phase. Overall Result:", gameState.examOverallResult); updateResourcesUI(); if (gameState.examOverallResult === 'FAIL') { examPhaseSummary.textContent = "You failed one or more courses! Your PhD journey ends here."; examPhaseRestart.classList.remove('hidden'); gameState.gameOver = true; } else { examPhaseSummary.textContent = "You passed all exams for the term!"; examPhaseContinue.classList.remove('hidden'); } }
        function proceedToNextTerm() { hideOverlay(examPhaseOverlay); if (gameState.gameOver) return; const currentSeasonIndex = SEASONS.indexOf(gameState.time.season); const nextSeasonIndex = (currentSeasonIndex + 1) % SEASONS.length; gameState.time.season = SEASONS[nextSeasonIndex]; if (gameState.time.season === 'Fall') { gameState.time.year++; logMessage(`A new academic year begins: Year ${gameState.time.year}`); if (gameState.currentStage.startsWith('PhD')) { const fee = 50 + (gameState.time.year * 10); gameState.resources.funding -= fee; logMessage(`Paid yearly student fees (-$${fee})`); } } gameState.currentStage = 'PhD (Coursework)'; if (gameState.currentTerm < COURSEWORK_TERMS + 2) { /* Extend slightly to allow for field courses */ enrollInCourses(gameState.currentTerm + 1); } else { logMessage("Coursework complete! Prepare for Comprehensive Exams."); gameState.currentStage = 'PhD (Comps Prep)'; updateUI(); } }
        const mainActions = [ { id: 'study', name: 'Study ðŸ“š', tooltip: "Choose a course to study" }, { id: 'sleep', name: 'Sleep ðŸ˜´', tooltip: "Recover Energy & Motivation" }, { id: 'buy', name: 'Buy ðŸ›’', tooltip: "Purchase items (Coming Soon!)" } ];
        function renderActionButtons() { actionButtonsContainer.innerHTML = ''; if (gameState.gamePhase !== 'main-game') return; console.log("Rendering action buttons..."); mainActions.forEach(action => { const button = document.createElement('button'); button.id = `action-${action.id}`; button.textContent = action.name; button.classList.add('game-button'); button.dataset.tooltip = action.tooltip; let disabled = false; let disabledReason = ""; if (gameState.currentActivity || gameState.isOverlayVisible) { disabled = true; disabledReason = "(Busy/Menu)"; } if (action.id === 'study' && gameState.currentCourses.length === 0) { disabled = true; disabledReason = "(No Courses)"; } if (action.id === 'buy') { disabled = true; disabledReason = "(Coming Soon!)"; } if (disabled) { button.classList.add('disabled'); button.disabled = true; button.dataset.tooltip += ` ${disabledReason}`; } else { if (action.id === 'study') button.onclick = openStudySubmenu; else if (action.id === 'sleep') button.onclick = performSleepAction; else if (action.id === 'buy') button.onclick = openBuyWindow; } actionButtonsContainer.appendChild(button); }); }
        function openStudySubmenu() { if (gameState.currentActivity || gameState.isOverlayVisible) return; studySubmenuList.innerHTML = ''; if(gameState.currentCourses.length === 0) { studySubmenuList.innerHTML = '<li>No courses to study!</li>'; } else { gameState.currentCourses.forEach((course, index) => { const li = document.createElement('li'); const button = document.createElement('button'); button.id = `study_${index}`; button.textContent = `Study ${course.name}`; button.classList.add('game-button'); button.dataset.tooltip = `Focus on ${course.name} (Cost: 20âš¡, 5ðŸ’¡)`; const studyCost = { energy: 20, motivation: 5 }; if (!canAfford(studyCost)) { button.classList.add('disabled'); button.disabled = true; button.dataset.tooltip += " (Need Resources)"; } else { button.onclick = () => performStudyAction(index, studyCost); } li.appendChild(button); studySubmenuList.appendChild(li); }); } showOverlay(studySubmenu); }
        function openBuyWindow() { if (gameState.currentActivity || gameState.isOverlayVisible) return; showOverlay(buyWindow); }
        function performSleepAction() { if (gameState.currentActivity || gameState.isOverlayVisible) return; const actionCost = { energy: -30, motivation: -15 }; const actionDuration = 4; gameState.currentActivity = { id: 'sleep_action', name: 'Sleeping', duration: actionDuration, remaining: actionDuration, cost: actionCost, effect: () => { const energyGain = Math.abs(actionCost.energy || 0); const motivationGain = Math.abs(actionCost.motivation || 0); gameState.resources.energy = Math.min(gameState.resources.maxEnergy, gameState.resources.energy + energyGain); gameState.resources.motivation = Math.min(gameState.resources.maxMotivation, gameState.resources.motivation + motivationGain); logMessage(`Slept well. (+${energyGain}âš¡, +${motivationGain}ðŸ’¡)`); } }; logMessage("Going to sleep..."); updateUI(); }
        function performStudyAction(courseIndex, cost) { console.log(`Attempting performStudyAction for index ${courseIndex}`); hideOverlay(studySubmenu); console.log(`Overlay hidden, isOverlayVisible: ${gameState.isOverlayVisible}`); if (gameState.currentActivity) { console.log("performStudyAction blocked: Activity already running."); logMessage("Cannot start studying: Already busy!"); return; } const course = gameState.currentCourses[courseIndex]; if (!course) { logMessage("Error: Course not found."); console.error("Course not found at index", courseIndex); return; } console.log(`Found course: ${course.name}`); const actionDuration = 3; const affordable = canAfford(cost); console.log(`Checking affordability: ${affordable}`); if (affordable) { gameState.resources.energy -= (cost.energy || 0); gameState.resources.motivation -= (cost.motivation || 0); console.log(`Resources deducted. Energy: ${gameState.resources.energy}, Motiv: ${gameState.resources.motivation}`); const newActivity = { id: `study_${courseIndex}`, name: `Studying ${course.name}`, duration: actionDuration, remaining: actionDuration, cost: cost, effect: () => { const effectCourse = gameState.currentCourses.find(c => c.name === course.name); if (!effectCourse || typeof gameState.stats[effectCourse.skill] === 'undefined') { console.error("Error in study effect: course or skill missing", effectCourse); return; } const understandingGain = (35 + Math.random() * 10) / (effectCourse.difficulty || 1.0); effectCourse.understanding = Math.min(100, effectCourse.understanding + understandingGain); const baseSkillGain = 0.5 / (effectCourse.difficulty || 1.0); const randomSkillBonus = Math.random() * 1.0; const totalSkillGain = baseSkillGain + randomSkillBonus; gameState.stats[effectCourse.skill] = (gameState.stats[effectCourse.skill] || 0) + totalSkillGain; logMessage(`Studied ${effectCourse.name}. +${understandingGain.toFixed(1)} Und. +${totalSkillGain.toFixed(1)} ${effectCourse.skill}`); updateCourseUI(); updateStatsUI(); } }; console.log("Setting currentActivity:", newActivity); gameState.currentActivity = newActivity; console.log("gameState.currentActivity after set:", gameState.currentActivity); logMessage(`Started studying ${course.name}.`); updateUI(); } else { logMessage(`Cannot study ${course.name}: Insufficient resources.`); if (gameState.resources.energy < (cost.energy || 0)) console.log("(Need more âš¡ Energy)"); if (gameState.resources.motivation < (cost.motivation || 0)) console.log("(Need more ðŸ’¡ Motivation)"); } }
        function performAction(actionId, actionList) { /* Kept for potential future generic actions */ if (gameState.gameOver || gameState.currentActivity || gameState.gamePhase !== 'main-game') { if (gameState.currentActivity) { logMessage(`Cannot start ${actionId}: Busy with ${gameState.currentActivity.name}.`); } return; } const action = actionList.find(a => a.id === actionId); if (!action) { logMessage(`Action ${actionId} not found.`); return; } if (action.condition && !action.condition()) { logMessage(`Cannot perform ${action.name}: Conditions not met.`); return; } if (canAfford(action.cost)) { gameState.resources.energy = Math.min(gameState.resources.maxEnergy, Math.max(0, gameState.resources.energy - (action.cost.energy || 0))); gameState.resources.motivation = Math.min(gameState.resources.maxMotivation, Math.max(0, gameState.resources.motivation - (action.cost.motivation || 0))); gameState.resources.funding = Math.max(-Infinity, gameState.resources.funding - (action.cost.funding || 0)); gameState.currentActivity = { id: action.id, name: action.name, duration: action.duration, remaining: action.duration, cost: action.cost, effect: action.effect }; logMessage(`Started: ${action.name}.`); updateUI(); } else { logMessage(`Cannot perform ${action.name}: Insufficient resources.`); if (gameState.resources.energy < (action.cost.energy || 0)) logMessage("(Need more âš¡ Energy)"); if (gameState.resources.motivation < (action.cost.motivation || 0)) logMessage("(Need more ðŸ’¡ Motivation)"); if (gameState.resources.funding < (action.cost.funding || 0)) logMessage("(Need more ðŸ’° Funding)"); } }
        function enableAcceptOfferButton() { logMessage("An offer is available! 'Accept Offer' action might be usable."); const acceptButton = document.getElementById('accept_offer_placeholder'); if(acceptButton) { acceptButton.dataset.enabled = 'true'; renderActionButtons(); } }
        function triggerRandomEvent() { const events = [ { name: "Good Sleep", effect: () => { gameState.resources.energy = Math.min(gameState.resources.maxEnergy, gameState.resources.energy + 15); logMessage("Event: Felt well-rested! (+15âš¡)"); } }, { name: "Sudden Insight", effect: () => { gameState.resources.motivation = Math.min(gameState.resources.maxMotivation, gameState.resources.motivation + 10); logMessage("Event: Research insight! (+10ðŸ’¡)"); } }, { name: "Imposter Syndrome", effect: () => { gameState.resources.motivation = Math.max(0, gameState.resources.motivation - 15); logMessage("Event: Imposter syndrome... (-15ðŸ’¡)"); } }, { name: "Advisor Praise", condition: () => gameState.currentStage.startsWith('PhD'), effect: () => { gameState.stats.advisorRelationship = Math.min(100, gameState.stats.advisorRelationship + 5); gameState.resources.motivation += 5; logMessage("Event: Advisor praise! (+5 Rel, +5ðŸ’¡)"); } }, ]; const possibleEvents = events.filter(event => !event.condition || event.condition()); if (possibleEvents.length > 0) { const randomEvent = possibleEvents[Math.floor(Math.random() * possibleEvents.length)]; randomEvent.effect(); } }

        // --- Main Game Loop Logic ---
        function advanceTime() { gameState.time.tick++; if (gameState.time.tick >= TICKS_PER_WEEK) { gameState.time.tick = 0; gameState.time.week++; gameState.resources.energy = Math.min(gameState.resources.maxEnergy, gameState.resources.energy + 10); gameState.resources.motivation = Math.min(gameState.resources.maxMotivation, gameState.resources.motivation + 5); if (gameState.currentStage.startsWith('PhD')) { gameState.resources.funding += 20; } if (gameState.time.week > WEEKS_PER_SEASON) { gameState.time.week = 1; logMessage(`End of ${gameState.time.season} Term, Year ${gameState.time.year}. Entering Exam Phase...`); runExamPhase(); } } }
        function processActivity() { if (!gameState.currentActivity) return; gameState.currentActivity.remaining--; if (gameState.currentActivity.remaining <= 0) { logMessage(`Finished: ${gameState.currentActivity.name}.`); try { if (typeof gameState.currentActivity.effect === 'function') { gameState.currentActivity.effect(); } else { console.error("Activity effect is not a function:", gameState.currentActivity); } } catch (error) { console.error("Error executing activity effect:", error); logMessage(`Error completing ${gameState.currentActivity.name}!`); } gameState.currentActivity = null; /* checkStageCompletion removed */ } }
        function checkGameOver() { if (gameState.gameOver) return; let reason = null; if (gameState.resources.energy <= 0) { reason = "You collapsed from exhaustion. Take better care of yourself!"; logMessage("Game Over: Ran out of energy."); } else if (gameState.resources.motivation <= 0) { reason = "You lost all motivation and dropped out. Academia is tough!"; logMessage("Game Over: Ran out of motivation."); } else if (gameState.resources.funding < -200) { reason = "You accumulated too much debt! Game Over."; logMessage("Game Over: Excessive debt."); } if (reason) { gameState.gameOver = true; clearTimeout(gameState.gameLoopTimeoutId); showModal("Game Over!", reason, true); } }
        function checkStageCompletion() { /* Now handled primarily by term progression and exam results */ }
        function changeStage(newStage) { gameState.currentStage = newStage; logMessage(`Entering stage: ${getStageName(newStage)}`); updateUI(); }
        function gameLoop() { if (gameState.isOverlayVisible) { console.log("Game loop paused (overlay visible)"); clearTimeout(gameState.gameLoopTimeoutId); gameState.gameLoopTimeoutId = setTimeout(gameLoop, gameState.gameSpeed); return; } if (gameState.gameOver || gameState.gamePhase !== 'main-game') { console.log(`Game loop stopping. gameOver: ${gameState.gameOver}, gamePhase: ${gameState.gamePhase}`); return; } console.log(`Game loop running: Y${gameState.time.year} ${gameState.time.season} W${gameState.time.week} T${gameState.time.tick}`); try { processActivity(); advanceTime(); if (Math.random() < 0.005) { triggerRandomEvent(); } updateUI(); checkGameOver(); } catch(e) { console.error("Error in game loop:", e); gameState.gameOver = true; } if (!gameState.gameOver) { clearTimeout(gameState.gameLoopTimeoutId); gameState.gameLoopTimeoutId = setTimeout(gameLoop, gameState.gameSpeed); } }
        function startGameLoop() { if (gameState.gamePhase !== 'main-game') { console.warn("Attempted to start game loop outside main-game phase."); return; } console.log("Attempting to start main game loop..."); clearTimeout(gameState.gameLoopTimeoutId); gameLoop(); }

        // --- Intro Sequence Logic (Unchanged) ---
        function startIntroAnimation() { console.log("Starting animation for school:", gameState.chosenSchool); introAnimationScreen.classList.remove('school-business', 'school-tech', 'school-ivyleague'); let schoolClass = 'school-business'; if (gameState.chosenSchool === 'Ivy League') { schoolClass = 'school-ivyleague'; } else if (gameState.chosenSchool === 'Tech Institute') { schoolClass = 'school-tech'; } introAnimationScreen.classList.add(schoolClass); introAnimationScreen.dataset.school = gameState.chosenSchool; const sprite = document.createElement('div'); sprite.className = 'walking-sprite'; introAnimationScreen.appendChild(sprite); animationText.textContent = `Walking towards ${gameState.chosenSchool}...`; let currentStep = 'left'; sprite.classList.add('step-left'); if (gameState.steppingIntervalId) { clearInterval(gameState.steppingIntervalId); } gameState.steppingIntervalId = setInterval(() => { if (!sprite || !sprite.parentNode) { clearInterval(gameState.steppingIntervalId); gameState.steppingIntervalId = null; return; } if (currentStep === 'left') { sprite.classList.remove('step-left'); sprite.classList.add('step-right'); currentStep = 'right'; } else { sprite.classList.remove('step-right'); sprite.classList.add('step-left'); currentStep = 'left'; } }, STEP_INTERVAL_MS); requestAnimationFrame(() => { setTimeout(() => { sprite.classList.add('is-walking'); }, 50); }); setTimeout(() => { console.log("Animation timeout finished. Clearing interval and switching phase."); if (gameState.steppingIntervalId) { clearInterval(gameState.steppingIntervalId); gameState.steppingIntervalId = null; } if (sprite && sprite.parentNode) { sprite.remove(); } switchGamePhase('main-game'); }, ANIMATION_DURATION); }
        function switchGamePhase(newPhase) { gameState.gamePhase = newPhase; console.log("Switching phase to:", newPhase); introWelcomeScreen.classList.add('hidden'); introSetupScreen.classList.add('hidden'); introAnimationScreen.classList.add('hidden'); mainGameInterface.classList.add('hidden'); switch (newPhase) { case 'intro-welcome': introWelcomeScreen.classList.remove('hidden'); titleImage.classList.remove('animate-in'); welcomeContinueButton.classList.remove('visible'); requestAnimationFrame(() => { setTimeout(() => { titleImage.classList.add('animate-in'); setTimeout(() => { welcomeContinueButton.classList.add('visible'); }, TITLE_ANIMATION_DURATION_MS + BUTTON_FADE_IN_DELAY_MS); }, 100); }); break; case 'intro-setup': introSetupScreen.classList.remove('hidden'); playerNameInput.value = gameState.playerName === "Player" ? "" : gameState.playerName; schoolChoiceButtons.forEach(btn => btn.classList.remove('selected')); setupStartButton.classList.add('disabled'); setupStartButton.disabled = true; gameState.chosenSchool = null; break; case 'intro-animation': introAnimationScreen.classList.remove('hidden'); startIntroAnimation(); break; case 'main-game': console.log("Switching to main-game phase..."); mainGameInterface.classList.remove('hidden'); enrollInCourses(1); updateUI(); startGameLoop(); break; } }

        // --- Event Handlers ---
        function handleWelcomeContinue() { switchGamePhase('intro-setup'); }
        function handleSchoolChoice(event) { gameState.chosenSchool = event.currentTarget.dataset.school; const bonusType = event.currentTarget.dataset.bonus; console.log("Chose school:", gameState.chosenSchool, "Bonus type:", bonusType); schoolChoiceButtons.forEach(btn => btn.classList.remove('selected')); event.currentTarget.classList.add('selected'); updateStartButtonState(); }
        function handleNameInput() { updateStartButtonState(); }
        function updateStartButtonState() { const nameEntered = playerNameInput.value.trim() !== ""; const schoolChosen = gameState.chosenSchool !== null; if (nameEntered && schoolChosen) { setupStartButton.classList.remove('disabled'); setupStartButton.disabled = false; } else { setupStartButton.classList.add('disabled'); setupStartButton.disabled = true; } }
        function handleSetupStart() { gameState.playerName = playerNameInput.value.trim() || "Player"; const selectedButton = document.querySelector('.school-choice-button.selected'); if (selectedButton) { gameState.chosenSchool = selectedButton.dataset.school; const bonusType = selectedButton.dataset.bonus; if (bonusType === 'metrics') { gameState.stats.econometrics += 5; } else if (bonusType === 'theory') { gameState.stats.microTheory += 3; gameState.stats.macroTheory += 3; } else if (bonusType === 'funding') { gameState.resources.funding += 300; } } else { gameState.chosenSchool = "State U"; } console.log("Starting PhD for:", gameState.playerName, "at", gameState.chosenSchool); /* Enroll moved */ switchGamePhase('intro-animation'); }

        // --- Initialization ---
        function initGame() {
            console.log("Initializing Econ Empire...");
            switchGamePhase('intro-welcome'); // Start at welcome screen
             // Add event listeners for intro screens
             welcomeContinueButton.addEventListener('click', handleWelcomeContinue);
             schoolChoiceButtons.forEach(button => { button.addEventListener('click', handleSchoolChoice); });
             playerNameInput.addEventListener('input', updateStartButtonState);
             setupStartButton.addEventListener('click', handleSetupStart);
             // Add listeners for overlay close/continue buttons
             termStartContinue.addEventListener('click', () => hideOverlay(termStartOverlay));
             studySubmenuClose.addEventListener('click', () => hideOverlay(studySubmenu));
             buyWindowClose.addEventListener('click', () => hideOverlay(buyWindow));
             examPhaseContinue.addEventListener('click', proceedToNextTerm);
             examPhaseRestart.addEventListener('click', () => window.location.reload());
             // Add listener for course selection confirm button
             courseConfirmButton.addEventListener('click', handleConfirmCourses);
        }

        // --- Start Game ---
         window.onload = function () { initGame(); }

    </script>

</body>
</html>
